<!DOCTYPE html>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Google Drive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .loading-ring {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .result-item {
            display: block;
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            padding: 1rem;
            border-radius: 0.75rem;
            transition: all 0.2s;
        }
        .result-item:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            border-color: #8b5cf6; /* Indigo-500 equivalent */
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">

    <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-2xl p-6 md:p-10">

        <!-- Encabezado -->
        <header class="mb-8 border-b pb-4">
            <h1 class="text-3xl font-bold text-gray-800">Buscador Inteligente de Documentos</h1>
            <p class="text-gray-500 mt-1">Busca por título o contenido dentro de la carpeta:</p>
            <p class="text-sm text-indigo-700 bg-indigo-50 p-2 rounded-lg mt-3 font-mono break-all">
                ID de Carpeta: 1AxsLjEXGdlAeBR6r5BTrrPVFy0nagSC4
            </p>
            <p class="text-sm text-yellow-600 mt-3">
                Para enfocar la búsqueda en esta carpeta, por favor, usa palabras clave **únicas** que sepas que solo se encuentran en los archivos de la misma.
            </p>
        </header>

        <!-- Formulario de Búsqueda -->
        <div class="flex flex-col md:flex-row gap-4 mb-8">
            <input
                type="text"
                id="searchQuery"
                placeholder="Ej: 'Resumen reporte trimestral' o 'datos de contacto cliente X'"
                class="flex-grow p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition duration-150"
                onkeypress="if(event.key === 'Enter') searchDrive()"
            >
            <button
                onclick="searchDrive()"
                id="searchButton"
                class="w-full md:w-auto px-6 py-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition duration-300 shadow-md flex items-center justify-center disabled:opacity-50"
            >
                <div id="loadingIndicator" class="hidden loading-ring mr-2"></div>
                <span id="buttonText">Buscar en Drive</span>
            </button>
        </div>

        <!-- Área de Resultados -->
        <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">Resultados de la Consulta</h2>
        <div id="results" class="space-y-4">
            <p class="text-gray-500 italic" id="initialMessage">Escribe una consulta y presiona "Buscar en Drive" para comenzar.</p>
        </div>
    </div>

    <script>
        // Función de utilidad para manejar el estado de la UI
        const $ = (id) => document.getElementById(id);
        const searchQueryInput = $('searchQuery');
        const searchButton = $('searchButton');
        const buttonText = $('buttonText');
        const loadingIndicator = $('loadingIndicator');
        const resultsArea = $('results');
        const initialMessage = $('initialMessage');

        // Variables de entorno
        const apiKey = ""; 
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:search?key=" + apiKey;

        // Implementación de Reintento con Backoff Exponencial
        async function fetchWithRetry(url, options, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);

                    // Si no es un código 200 (OK), intentamos leer el error detallado
                    if (!response.ok) {
                        const errorBody = await response.json().catch(() => ({ message: "No se pudo obtener el cuerpo del error." }));
                        
                        // Si el error es 4xx o 5xx, lo registramos y lanzamos la excepción con el detalle
                        console.error(`Intento ${i + 1} fallido con estado ${response.status}:`, errorBody);
                        
                        // Lanzamos una excepción con el mensaje de error de Google
                        const errorMessage = errorBody.error?.message || errorBody.message || "Error de API desconocido.";
                        throw new Error(`Error en la API: HTTP ${response.status} - ${errorMessage}`);
                    }
                    return response;
                } catch (error) {
                    if (i < retries - 1) {
                        // Espera con backoff exponencial
                        const delay = Math.pow(2, i) * 1000; // 1s, 2s, 4s de espera
                        console.warn(`Error transitorio detectado, reintentando en ${delay / 1000}s...`, error.message);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw error; // Último intento fallido, lanzamos el error final
                    }
                }
            }
        }

        function setUILoading(isLoading) {
            searchQueryInput.disabled = isLoading;
            searchButton.disabled = isLoading;
            loadingIndicator.classList.toggle('hidden', !isLoading);
            buttonText.textContent = isLoading ? 'Buscando...' : 'Buscar en Drive';
        }

        function renderResults(results) {
            if (!results || results.length === 0) {
                resultsArea.innerHTML = '<div class="p-4 bg-blue-100 border border-blue-400 text-blue-700 rounded-xl">No se encontraron documentos relevantes para su consulta.</div>';
                return;
            }

            let resultsHTML = '';
            results.forEach((result, index) => {
                // El campo 'summarized_content' contiene el snippet relevante
                const title = result.id || 'Documento sin título';
                const snippet = result.summarized_content || 'Contenido no disponible o demasiado corto.';
                
                // Generamos un URL de ejemplo con el ID del documento
                const mockUrl = `https://drive.google.com/open?id=${result.id}`; 

                resultsHTML += `
                    <div class="result-item">
                        <a href="${mockUrl}" target="_blank" class="text-lg font-semibold text-indigo-600 hover:text-indigo-800 transition duration-150">${index + 1}. ${title}</a>
                        <p class="text-sm text-gray-700 mt-1 line-clamp-2">${snippet}</p>
                        <span class="text-xs text-gray-400 mt-2 block">Fuente: Google Drive</span>
                    </div>
                `;
            });
            resultsArea.innerHTML = resultsHTML;
        }

        async function searchDrive() {
            const query = searchQueryInput.value.trim();

            if (query.length < 5) {
                resultsArea.innerHTML = '<div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-xl">Por favor, introduce una consulta más específica (mínimo 5 caracteres).</div>';
                return;
            }

            setUILoading(true);
            initialMessage.classList.add('hidden');
            resultsArea.innerHTML = ''; 

            console.log(`Iniciando búsqueda en Google Drive con la consulta: "${query}"`);

            const payload = {
                tool: {
                    "gemkick_corpus": {
                        "search": {
                            "corpus": "GOOGLE_DRIVE",
                            "query": query
                        }
                    }
                }
            };
            
            try {
                // Usamos fetchWithRetry para mayor estabilidad
                const response = await fetchWithRetry(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                
                // Extraer resultados del corpus
                const searchResults = result?.context_fetch_results || [];
                
                // Renderizar los resultados en la UI
                renderResults(searchResults);

            } catch (error) {
                console.error("Fallo final al ejecutar la búsqueda:", error);
                
                // Mostramos un error más detallado en la UI
                const displayMessage = error.message.includes("Error en la API") 
                    ? `Error: ${error.message}` 
                    : `Error de conexión: ${error.message}. Revise la consola.`;

                resultsArea.innerHTML = `
                    <div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-xl font-semibold">
                        ${displayMessage}
                    </div>
                    <p class="text-sm text-gray-600 mt-2">
                        Si el error persiste, es probable que se deba a permisos de acceso a Google Drive en este entorno.
                    </p>
                `;
            } finally {
                setUILoading(false);
            }
        }
    </script>

</body>
</html>
